<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <title>Crypto Screener</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; color: #333; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #333; color: white; }
    tr:nth-child(even) { background: #f2f2f2; }
    .green { color: green; font-weight: bold; }
    .red { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Топ 100 криптовалути – базов технически анализ</h2>
  <table id="crypto-table">
    <thead>
      <tr>
        <th>Валута</th>
        <th>Текуща цена (USD)</th>
        <th>Очаквана промяна (%)</th>
        <th>Сигнали (RSI/MACD/BB/OBV/Fib)</th>
        <th>Очаквана цена (24h)</th>
        <th>Цена за покупка</th>
        <th>Цена за продажба</th>
        <th>Подкрепа</th>
        <th>Съпротива</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function loadData() {
      const url = "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false&price_change_percentage=1h,24h,7d,14d,30d";
      const res = await fetch(url);
      const data = await res.json();

      const table = document.querySelector("#crypto-table tbody");

      data.forEach(c => {
        const price = c.current_price;
        const change24h = c.price_change_percentage_24h || 0;

        // Очаквана промяна: приближение (ако имаме данни за 7д, 14д и 30д)
        const momentum = (c.price_change_percentage_7d_in_currency || 0) 
                       + (c.price_change_percentage_14d_in_currency || 0)
                       + (c.price_change_percentage_30d_in_currency || 0);
        const expectedChange = (change24h + momentum / 3) / 2;

        // Очаквана цена (24h)
        const expectedPrice = price * (1 + expectedChange / 100);

        // Базови подкрепа/съпротива (±5%)
        const support = (price * 0.95).toFixed(2);
        const resistance = (price * 1.05).toFixed(2);

        // Покупка/продажба (приближение)
        const buy = (price * 0.99).toFixed(2);
        const sell = (price * 1.02).toFixed(2);

// Индикатори с по-реалистична логика
let signalsArr = [];

// RSI (приближение от 14 дни)
if ((c.price_change_percentage_14d_in_currency || 0) > 10) {
  signalsArr.push('<span class="green">RSI</span>');
} else if ((c.price_change_percentage_14d_in_currency || 0) < -10) {
  signalsArr.push('<span class="red">RSI</span>');
} else {
  signalsArr.push("RSI");
}

// MACD (7д > 14д > 30д = бичо)
if (
  (c.price_change_percentage_7d_in_currency || 0) >
    (c.price_change_percentage_14d_in_currency || 0) &&
  (c.price_change_percentage_14d_in_currency || 0) >
    (c.price_change_percentage_30d_in_currency || 0)
) {
  signalsArr.push('<span class="green">MACD</span>');
} else {
  signalsArr.push('<span class="red">MACD</span>');
}

// Bollinger Bands (24h промяна > ±5%)
if (change24h > 5) {
  signalsArr.push('<span class="green">BB</span>');
} else if (change24h < -5) {
  signalsArr.push('<span class="red">BB</span>');
} else {
  signalsArr.push("BB");
}

// OBV (обем + посока на промяната)
if (c.total_volume > 0) {
  if (change24h > 0) {
    signalsArr.push('<span class="green">OBV</span>');
  } else {
    signalsArr.push('<span class="red">OBV</span>');
  }
} else {
  signalsArr.push("OBV");
}

// Fibonacci (позиция спрямо дневен диапазон)
if (c.high_24h && c.low_24h && c.current_price) {
  let range = c.high_24h - c.low_24h;
  if (range > 0) {
    let pos = (c.current_price - c.low_24h) / range;
    if (pos > 0.8) {
      signalsArr.push('<span class="green">Fib</span>');
    } else if (pos < 0.2) {
      signalsArr.push('<span class="red">Fib</span>');
    } else {
      signalsArr.push("Fib");
    }
  }
}

const signals = signalsArr.join(" / ");


        const row = `
          <tr>
            <td>${c.name} (${c.symbol.toUpperCase()})</td>
            <td>${price.toFixed(4)}</td>
            <td>${expectedChange.toFixed(2)}%</td>
            <td>${signals}</td>
            <td>${expectedPrice.toFixed(4)}</td>
            <td>${buy}</td>
            <td>${sell}</td>
            <td>${support}</td>
            <td>${resistance}</td>
          </tr>
        `;
        table.innerHTML += row;
      });

      // Сортиране по "Очаквана промяна (%)"
      const rows = Array.from(table.querySelectorAll("tr"));
      rows.sort((a, b) => parseFloat(b.cells[2].textContent) - parseFloat(a.cells[2].textContent));
      rows.forEach(r => table.appendChild(r));
    }

    loadData();
  </script>
</body>
</html>
