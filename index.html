<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <title>Crypto Technical Screener - Top 100</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
    h1 { text-align: center; }
    table { border-collapse: collapse; width: 100%; font-size: 14px; background: white; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #eee; }
    .green { color: green; font-weight: bold; }
    .red { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Crypto Technical Screener - Top 100</h1>
  <table id="crypto-table">
    <thead>
      <tr>
        <th>Валута</th>
        <th>Текуща цена (USD)</th>
        <th>Очаквана промяна (%)</th>
        <th>Сигнали</th>
        <th>Очаквана цена (24h)</th>
        <th>Цена за покупка</th>
        <th>Цена за продажба</th>
        <th>Подкрепа</th>
        <th>Съпротива</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function fetchCoins() {
      const url = "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=200&page=1";
      const res = await fetch(url);
      return res.json();
    }

    async function fetchMarketChart(id) {
      const url = `https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=usd&days=30&interval=daily`;
      const res = await fetch(url);
      return res.json();
    }

    // RSI
    function calculateRSI(closes, period = 14) {
      if (closes.length < period) return null;
      let gains = 0, losses = 0;
      for (let i = 1; i <= period; i++) {
        const diff = closes[i] - closes[i-1];
        if (diff >= 0) gains += diff;
        else losses -= diff;
      }
      const rs = (gains / period) / (losses / period || 1);
      return 100 - (100 / (1 + rs));
    }

    // EMA helper
    function ema(values, period) {
      const k = 2 / (period + 1);
      let emaArr = [];
      emaArr[0] = values[0];
      for (let i = 1; i < values.length; i++) {
        emaArr[i] = values[i] * k + emaArr[i-1] * (1 - k);
      }
      return emaArr;
    }

    // MACD
    function calculateMACD(closes) {
      const ema12 = ema(closes, 12);
      const ema26 = ema(closes, 26);
      let macd = [];
      for (let i = 0; i < closes.length; i++) {
        macd[i] = (ema12[i] || 0) - (ema26[i] || 0);
      }
      const signal = ema(macd, 9);
      return macd[macd.length-1] - signal[signal.length-1];
    }

    // Bollinger Bands
    function calculateBB(closes, period = 20) {
      if (closes.length < period) return {};
      const recent = closes.slice(-period);
      const avg = recent.reduce((a,b)=>a+b,0)/period;
      const variance = recent.reduce((a,b)=>a+Math.pow(b-avg,2),0)/period;
      const stdev = Math.sqrt(variance);
      return { mid: avg, upper: avg+2*stdev, lower: avg-2*stdev };
    }

    // OBV
    function calculateOBV(closes, volumes) {
      let obv = 0;
      for (let i=1;i<closes.length;i++) {
        if (closes[i] > closes[i-1]) obv += volumes[i];
        else if (closes[i] < closes[i-1]) obv -= volumes[i];
      }
      return obv;
    }

    // Fibonacci
    function calculateFib(closes) {
      const high = Math.max(...closes);
      const low = Math.min(...closes);
      return {
        levels: [
          high,
          high - 0.236*(high-low),
          high - 0.382*(high-low),
          high - 0.5*(high-low),
          high - 0.618*(high-low),
          low
        ]
      };
    }

    function getSignals(rsi, macd, bb, obvTrend, price, fib) {
      let signals = [];
      signals.push(rsi < 30 ? '<span class="green">RSI</span>' : rsi > 70 ? '<span class="red">RSI</span>' : '');
      signals.push(macd > 0 ? '<span class="green">MACD</span>' : '<span class="red">MACD</span>');
      signals.push(price <= bb.lower ? '<span class="green">BB</span>' : price >= bb.upper ? '<span class="red">BB</span>' : '');
      signals.push(obvTrend > 0 ? '<span class="green">OBV</span>' : '<span class="red">OBV</span>');
      const fibSup = fib.levels[5], fibRes = fib.levels[0];
      signals.push(price - fibSup < (fibRes - fibSup)/3 ? '<span class="green">Fib</span>' : '<span class="red">Fib</span>');
      return signals.filter(s=>s).join(", ");
    }

    async function buildTable() {
      const coins = await fetchCoins();
      let rows = [];

      for (let coin of coins) {
        try {
          const data = await fetchMarketChart(coin.id);
          const closes = data.prices.map(p=>p[1]);
          const volumes = data.total_volumes.map(v=>v[1]);
          const price = closes[closes.length-1];

          const rsi = calculateRSI(closes);
          const macd = calculateMACD(closes);
          const bb = calculateBB(closes);
          const obv = calculateOBV(closes, volumes);
          const fib = calculateFib(closes);

          const obvTrend = obv; // simplified
          const signals = getSignals(rsi, macd, bb, obvTrend, price, fib);

          let expectedChange = 0;
          if (signals.includes("green")) expectedChange += 5;
          if (signals.includes("red")) expectedChange -= 2;

          const expectedPrice = price * (1 + expectedChange/100);
          const support = fib.levels[5].toFixed(2);
          const resistance = fib.levels[0].toFixed(2);

          rows.push({
            name: coin.name,
            price: price.toFixed(2),
            change: expectedChange,
            signals: signals,
            expPrice: expectedPrice.toFixed(2),
            buy: (price*0.99).toFixed(2),
            sell: (price*1.02).toFixed(2),
            support: support,
            resistance: resistance
          });
        } catch(e) {
          console.log("Error with coin", coin.id, e);
        }
      }

      rows.sort((a,b)=>b.change - a.change);

      const tbody = document.querySelector("#crypto-table tbody");
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${r.price}</td>
          <td>${r.change.toFixed(2)}%</td>
          <td>${r.signals}</td>
          <td>${r.expPrice}</td>
          <td>${r.buy}</td>
          <td>${r.sell}</td>
          <td>${r.support}</td>
          <td>${r.resistance}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    buildTable();
  </script>
</body>
</html>